(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();const pt="​",ut="‌",J="‍",V="⁠",xt=V+ut+J,yt=V+pt+J,It=new TextEncoder;new TextDecoder;function gt(h){const e=It.encode(h);return Array.from(e,n=>n.toString(2).padStart(8,"0").replace(/0/g,pt).replace(/1/g,ut)).join(J)}function k(h){const e=gt(String(h));return xt+e+V}function L(h){const e=gt(String(h));return yt+e+V}function Z(){return/\u2060[\u200B\u200C]\u200D[\u200B\u200C]+(?:\u200D[\u200B\u200C]+)*\u2060/g}function q(h,e){const t=k(e),n=L(e);return h.includes(t)&&h.includes(n)}function _(h){const e=Z(),t=[],n=[];for(let a=0;a<h.length;){e.lastIndex=a;const s=e.exec(h);if(s!==null&&s.index===a){const r=s[0].length;a=a+r;continue}n.push(a),t.push(h[a]),a=a+1}return{cleanText:t.join(""),cleanToRawIndex:n}}function X(h,e,t){if(!e||e.length===0)return-1;if(t!=null&&Number.isInteger(t)&&t>=0){let n=0;for(let a=0;a<=t;a++){const s=z(h,e,n);if(s<0)return-1;if(a===t)return s;n=s+e.length}return-1}return z(h,e)}function z(h,e,t=0){const n=h.toLowerCase(),a=e.toLowerCase();return n.indexOf(a,t)}function K(h){if(!h||!h.data||!h.data.initialText)throw new Error(`[buildTargets] Missing initialText for current item | id=${h?h.id:"unknown"}, shapeId=${h?h.shapeId:"unknown"}, occurrenceIndex=${h&&h.data?h.data.occurrenceIndex??"first":"unknown"}`);const e=[{id:h.id,shapeId:h.shapeId,initialText:h.data.initialText,occurrenceIndex:h.data.occurrenceIndex??null}];if(h.data.hasSiblings&&Array.isArray(h.data.siblings))for(const t of h.data.siblings){if(!t||!t.initialText)throw new Error(`[buildTargets] Missing initialText for a sibling | parentId=${h.id}, shapeId=${h.shapeId}, siblingId=${t?t.id:"unknown"}, occurrenceIndex=${t?t.occurrenceIndex??"first":"unknown"}`);e.push({id:t.id,shapeId:h.shapeId,initialText:t.initialText,occurrenceIndex:t.occurrenceIndex??null})}return e}function F(h,e){return{allCaps:h?.allCaps||!!e.allCaps,bold:h?.bold||!!e.bold,color:h?.color||e.color||void 0,doubleStrikethrough:h?.doubleStrikethrough||!!e.doubleStrikethrough,italic:h?.italic||!!e.italic,name:h?.name||e.name||void 0,size:h?.size||e.size||void 0,strikethrough:h?.strikethrough||!!e.strikethrough,subscript:h?.subscript||!!e.subscript,superscript:h?.superscript||!!e.superscript,underline:h?.underline||e.underline||void 0}}function rt(h,e,t,n,a){if(!n||e<0||t<=e)throw new Error(`[formatTextRuns] Invalid proposedText or indices provided for text replacement in table: proposedText=${n}, startIndex=${e}, endIndex=${t}`);const s=[],r=[];let i=0,d="before",l=!1,o;for(let c=0;c<h.length;c+=1){const p=h[c],u=p.text??"",g=u.length,f=i,w=f+g;if(i=w,g===0)continue;if(!!(t<=f||e>=w)){r.push({text:u,font:F(p.font,a)}),d==="inside"&&(d="after");continue}const m=Math.max(0,e-f),x=Math.min(g,t-f),S=F(p.font,a);if(d==="before"){const R=u.slice(0,m);R.length>0&&r.push({text:R,font:S})}const b=u.slice(m,x);if(b.length>0&&(o||(o=S),s.push({text:b,font:S})),t<=w){l||(r.push({text:n,font:o??S}),l=!0);const R=u.slice(x);R.length>0&&r.push({text:R,font:S}),d="after"}else d="inside";i=w}return{initialTextRuns:s,proposedTextRuns:r}}function mt(h){const e=[];for(const t of h){const n=t.items.filter(r=>r.hasSibling),a=new Set,s=[];for(const r of n){const i=r.shapeType==="table"?`${r.shapeId}::${r.column}::${r.row}`:r.shapeId;a.has(i)||(a.add(r.shapeId),s.push(r))}s.length>0&&e.push({...t,items:s})}return e}class I{static async clearMarkersFromShape(e,t){e.textFrame.textRange.load("text"),await t.sync();const n=e.textFrame.textRange.text,a=Z(),s=Array.from(n.matchAll(a));if(s.length===0)return 0;for(let r=s.length-1;r>=0;r--){const i=s[r];if(i.index==null)continue;const d=i.index,l=i[0].length,o=e.textFrame.textRange.getSubstring(d,l);o.load("text"),await t.sync(),o.text="",await t.sync()}return s.length}static async wrapSubstringWithMarkersForShape(e,t,n,a,s){const r=e.textFrame.textRange.getSubstring(t,n);r.load("text"),await s.sync();const i=r.text,d=k(a),l=L(a);r.text=d+i+l,await s.sync()}static async addMarkersForShape(e,t,n){const a=K(t);e.textFrame.textRange.load("text"),await n.sync();let s=e.textFrame.textRange.text;for(let r=0;r<a.length;r++){const i=a[r];if(q(s,i.id))continue;const d=_(s),l=X(d.cleanText,i.initialText,i.occurrenceIndex??null);if(l<0)throw new Error(`[ensureMarkersForTextRange] initialText not found | id=${i.id}, shapeId=${i.shapeId}, initialText="${i.initialText}", occurrenceIndex=${i.occurrenceIndex??"first"}`);const o=l+i.initialText.length,c=d.cleanToRawIndex[l],u=(o<d.cleanToRawIndex.length?d.cleanToRawIndex[o]:s.length)-c;await I.wrapSubstringWithMarkersForShape(e,c,u,i.id,n),e.textFrame.textRange.load("text"),await n.sync(),s=e.textFrame.textRange.text}}static async findTargetRangeInShape(e,t,n){if(!t||!t.data||!t.data.initialText)throw new Error(`[findTargetRangeInShape] Missing initialText | id=${t?t.id:"unknown"}, shapeId=${t?t.shapeId:"unknown"}, occurrenceIndex=${t&&t.data?t.data.occurrenceIndex??"first":"unknown"}`);if(!t.data.hasSiblings){await I.clearMarkersFromShape(e,n),e.textFrame.textRange.load("text"),await n.sync();const o=e.textFrame.textRange.text,c=z(o,t.data.initialText);if(c<0)throw new Error(`[findTargetRangeInShape] initialText not found (no siblings flow) | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}"`);return{rawStart:c,rawLength:t.data.initialText.length,foundBy:"text"}}e.textFrame.textRange.load("text"),await n.sync();let a=e.textFrame.textRange.text;q(a,t.id)||(await I.addMarkersForShape(e,t,n),e.textFrame.textRange.load("text"),await n.sync(),a=e.textFrame.textRange.text);const s=k(t.id),r=L(t.id),i=a.indexOf(s);if(i<0)throw new Error(`[findTargetRangeInShape] START marker not found | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);const d=i+s.length,l=a.indexOf(r,d);if(l<0)throw new Error(`[findTargetRangeInShape] END marker not found | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);return{rawStart:d,rawLength:l-d,foundBy:"marker"}}static async replaceTextInShape(e,t,n,a){if(n){if(!t||!t.data||!t.data.initialText)throw new Error(`[replaceTextInShape] Missing initialText | id=${t.id}, shapeId=${t.shapeId}, occurrenceIndex=${t.data.occurrenceIndex}`);const i=e.textFrame.textRange.text,d=z(i,t.data.initialText),l=d+t.data.initialText.length;e.textFrame.textRange.text=`${i.slice(0,d)}${i.slice(d,l)}${i.slice(l)}`}const s=await I.findTargetRangeInShape(e,t,a),r=e.textFrame.textRange.getSubstring(s.rawStart,s.rawLength);r.load("text"),await a.sync(),r.text=t.data.proposedText,await a.sync()}static async clearMarkersFromSimpleCell(e,t){e.load(["text"]),await t.sync();const n=e.text||"",a=Z(),s=Array.from(n.matchAll(a));if(s.length===0)return 0;const r=_(n);return e.text=r.cleanText,await t.sync(),s.length}static async wrapSubstringWithMarkersInSimpleCell(e,t,n,a,s){e.load(["text"]),await s.sync();const r=e.text||"",i=k(a),d=L(a),l=r.slice(0,t),o=r.slice(t,t+n),c=r.slice(t+n);e.text=l+i+o+d+c,await s.sync()}static async addMarkersForSimpleCell(e,t,n){e.load(["text"]),await n.sync();let a=e.text||"";const s=K(t);for(let r=0;r<s.length;r++){const i=s[r];if(q(a,i.id))continue;const d=_(a),l=X(d.cleanText,i.initialText,i.occurrenceIndex??0);if(l<0)throw new Error(`[addMarkersForSimpleCell] initialText not found | id=${i.id}, shapeId=${t.shapeId}, initialText="${i.initialText}", occurrenceIndex=${i.occurrenceIndex??"first"}`);const o=l+i.initialText.length,c=d.cleanToRawIndex[l],u=(o<d.cleanToRawIndex.length?d.cleanToRawIndex[o]:a.length)-c;await I.wrapSubstringWithMarkersInSimpleCell(e,c,u,i.id,n),e.load(["text"]),await n.sync(),a=e.text||""}}static async findTargetRangeInSimpleCell(e,t,n){if(!t||!t.data||!t.data.initialText)throw new Error(`[findTargetRangeInSimpleCell] Missing initialText | id=${t?t.id:"unknown"}, shapeId=${t?t.shapeId:"unknown"}, occurrenceIndex=${t&&t.data?t.data.occurrenceIndex??"first":"unknown"}`);if(!t.data.hasSiblings){await I.clearMarkersFromSimpleCell(e,n),e.load(["text"]),await n.sync();const o=e.text||"",c=z(o,t.data.initialText);if(c<0)throw new Error(`[findTargetRangeInSimpleCell] initialText not found (no siblings flow) | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}"`);return{rawStart:c,rawLength:t.data.initialText.length,foundBy:"text"}}await I.addMarkersForSimpleCell(e,t,n),e.load(["text"]),await n.sync();const a=e.text||"",s=k(t.id),r=L(t.id),i=a.indexOf(s);if(i<0)throw new Error(`[findTargetRangeInSimpleCell] START marker not found | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);const d=i+s.length,l=a.indexOf(r,d);if(l<0)throw new Error(`[findTargetRangeInSimpleCell] END marker not found | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);return{rawStart:d,rawLength:l-d,foundBy:"marker"}}static async replaceTextInSimpleCell(e,t,n){const a=await I.findTargetRangeInSimpleCell(e,t,n);e.load(["text"]),await n.sync();const s=e.text||"",r=s.slice(0,a.rawStart),i=s.slice(a.rawStart+a.rawLength);e.text=r+t.data.proposedText+i,await n.sync()}static async replaceTextInFormattedCell(e,t,n){e.load(["textRuns","font","horizontalAlignment"]),await n.sync();const a=e.horizontalAlignment;if(!e.textRuns||e.textRuns.length===0)throw new Error(`[replaceTextInFormattedCell] No TextRuns found | id=${t.id}, shapeId=${t.shapeId}, initialText=${t.data?.initialText??"<empty>"}`);const{proposedTextRuns:s,initialTextRuns:r}=await I.getUpdatedTextRuns(e,t,n);return e.textRuns=s,e.horizontalAlignment=a,await n.sync(),{initialTextRuns:r}}static async revertTextInFormattedCell(e,t,n){e.load(["textRuns","horizontalAlignment"]),await n.sync();const a=e.horizontalAlignment,s=e.textRuns;if(!s||s.length===0)throw new Error(`[revertTextInFormattedCell] No TextRuns found | id=${t.id}, shapeId=${t.shapeId}, initialText=${t.data?.initialText??"<empty>"}`);const r=t.data.proposedTextRuns;if(!r||r.length===0)throw new Error(`[revertTextInFormattedCell] proposedTextRuns is missing or empty | id=${t.id}, shapeId=${t.shapeId}, initialText=${t.data?.initialText??"<empty>"}`);const i=k(t.id),d=L(t.id),l=[];let o=!1;for(const c of s){const p=c.text;if(!o&&p.includes(i)&&p.includes(d)){const u=p.indexOf(i),g=p.indexOf(d)+d.length,f=p.slice(0,u),w=p.slice(g);f.length>0&&l.push({text:f,font:F(c.font,e.font)}),l.push(...r),w.length>0&&l.push({text:w,font:F(c.font,e.font)}),o=!0;continue}l.push(c)}if(!o)throw new Error(`[revertTextInFormattedCell] Marker-wrapped content not found in a single run | id=${t.id}, shapeId=${t.shapeId}, initialText=${t.data?.initialText??"<empty>"}`);e.textRuns=l,e.horizontalAlignment=a,await n.sync()}static async getUpdatedTextRuns(e,t,n){if(!t||!t.data||!t.data.initialText)throw new Error(`[getUpdatedTextRuns] Missing initialText | id=${t?t.id:"unknown"}, shapeId=${t?t.shapeId:"unknown"}`);e.load(["textRuns","font"]),await n.sync();let a=e.textRuns||[];const s=e.font;let r=I.getTextRunsFullText(a);if(t.data.hasSiblings){const p=I.addMarkersForFormattedCell(a,t,e.font);p.length&&(a=p,r=I.getTextRunsFullText(a));const u=k(t.id),g=L(t.id),f=r.indexOf(u);if(f<0)throw new Error(`[getUpdatedTextRuns] START marker not found | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);const w=r.indexOf(g,f+u.length);if(w<0||w<=f)throw new Error(`[getUpdatedTextRuns] END marker not found or invalid | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}", occurrenceIndex=${t.data.occurrenceIndex??"first"}`);const y=w+g.length,m=u+t.data.proposedText+g;return rt(a,f,y,m,s)}const i=_(r),d=X(i.cleanText,t.data.initialText,0);if(d<0)throw new Error(`[getUpdatedTextRuns] initialText not found (no siblings flow) | id=${t.id}, shapeId=${t.shapeId}, initialText="${t.data.initialText}"`);const l=d+t.data.initialText.length,o=i.cleanToRawIndex[d],c=l<i.cleanToRawIndex.length?i.cleanToRawIndex[l]:r.length;return rt(a,o,c,t.data.proposedText||"",s)}static addMarkersForFormattedCell(e,t,n){if(!Array.isArray(e)||e.length===0)return[];let a=e.map(r=>({text:r.text,font:F(r.font,n)}));const s=K(t);for(const r of s){const i=I.getTextRunsFullText(a);if(q(i,r.id))continue;const d=_(i),l=X(d.cleanText,r.initialText,r.occurrenceIndex??0);if(l<0)throw new Error(`[addMarkersForFormattedCell] initialText not found | id=${r.id}, shapeId=${t.shapeId}, initialText="${r.initialText}", occurrenceIndex=${r.occurrenceIndex??"first"}`);const o=l+r.initialText.length,c=d.cleanToRawIndex[l],p=o<d.cleanToRawIndex.length?d.cleanToRawIndex[o]:i.length,u=L(r.id);a=I.insertMarkerIntoRuns(a,p,u,!1,n);const g=k(r.id);a=I.insertMarkerIntoRuns(a,c,g,!0,n)}return a}static getTextRunsFullText(e){return e.map(t=>t.text).join("")}static insertMarkerIntoRuns(e,t,n,a,s){const r=[];let i=0;for(const d of e){const l=d.text,o=i+l.length;if(t===i){r.push({text:n+l,font:F(d.font,s)}),i=o+n.length;continue}if(t===o)if(a){r.push({text:l,font:F(d.font,s)}),i=o;continue}else{r.push({text:l+n,font:F(d.font,s)}),i=o+n.length;continue}if(t<i||t>o){r.push({text:l,font:F(d.font,s)}),i=o;continue}const c=t-i,p=l.slice(0,c),u=l.slice(c),g=p+n+u;r.push({text:g,font:F(d.font,s)}),i=o+n.length}return r}static async cleanMarkersByChangelog(e){let t=0,n=0;return await PowerPoint.run(async a=>{for(const s of e){const r=a.presentation.slides.getItem(s.slideId),i=new Set;for(const d of s.items)d&&d.shapeId.length>0&&i.add(d.shapeId);for(const d of Array.from(i))try{const l=r.shapes.getItem(d),o=await I.clearMarkersFromShape(l,a);o>0&&(t=t+1,n=n+o)}catch{}}}),{cleanedShapesCount:t,cleanedMatchesCount:n}}}const N={BG_GRAY:"#D9D9D9",BLACK:"#000000",GRAY:"#7F7F7F",RED:"#E34037",ORANGE:"#E39837",YELLOW:"#E3C337",GREEN:"#52CF76",WHITE:"#FFFFFF"},D="HIGHLIGHT",Tt=10,St=4,it="#FF00FF",Rt="#5a5a5a",ot="#00FFFF",dt=24,$t=2880,bt=!0,ft=.3;function Et(h){return"proposedText"in h}function lt(h){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:255,g:0,b:255}}function Ft(h,e,t,n,a){return Math.abs(h-n.r)<=a&&Math.abs(e-n.g)<=a&&Math.abs(t-n.b)<=a}async function Ct(h){const e=`data:image/png;base64,${h}`,t=new Image;t.crossOrigin="anonymous",await new Promise((s,r)=>{t.onload=()=>s(),t.onerror=()=>r(new Error("Failed to load exported slide PNG")),t.src=e});const n=document.createElement("canvas");n.width=t.naturalWidth,n.height=t.naturalHeight;const a=n.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("Canvas 2D context is not available");return a.drawImage(t,0,0),{canvasContext:a,width:n.width,height:n.height,canvas:n}}function Mt(h,e,t){const n=t.width/e.width,a=t.height/e.height,s=t.left+(h.x-e.x)*n,r=t.top+(h.y-e.y)*a,i=h.width*n,d=h.height*a;return{left:s,top:r,width:i,height:d}}function ct(h,e,t,n,a,s){const r=s?Math.max(0,Math.floor(s.x)):0,i=s?Math.max(0,Math.floor(s.y)):0,d=s?Math.min(e,Math.ceil(s.x+s.width)):e,l=s?Math.min(t,Math.ceil(s.y+s.height)):t,o=d-r,c=l-i,u=h.getImageData(r,i,o,c).data,g=new Uint8Array(o*c),f=[];function w(x,S){const b=(S*o+x)*4,R=u[b],O=u[b+1],H=u[b+2];return u[b+3]>0&&Ft(R,O,H,n,a)}const y=[],m=[];for(let x=0;x<c;x+=1)for(let S=0;S<o;S+=1){const b=x*o+S;if(g[b]===1||(g[b]=1,!w(S,x)))continue;let R=S,O=x,H=S,v=x;for(y.length=0,m.length=0,y.push(S),m.push(x);y.length>0;){const T=y.pop(),C=m.pop();T<R&&(R=T),C<O&&(O=C),T>H&&(H=T),C>v&&(v=C);const M=[{nx:T-1,ny:C},{nx:T+1,ny:C},{nx:T,ny:C-1},{nx:T,ny:C+1}];for(const{nx:G,ny:P}of M){if(G<0||P<0||G>=o||P>=c)continue;const W=P*o+G;g[W]!==1&&(g[W]=1,w(G,P)&&(y.push(G),m.push(P)))}}f.push({x:r+R,y:i+O,width:H-R+1,height:v-O+1})}return f}function At(h){const a=h.filter(o=>o.width*o.height>=25);if(a.length===0)return[];a.sort((o,c)=>o.y-c.y||o.x-c.x);const s=a.map(o=>o.height).sort((o,c)=>o-c),r=s[Math.floor(s.length/2)]||1,i=Math.max(1,Math.round(r*10)),d=[];for(const o of a){let c=!1;for(const p of d){const u=Math.min(...p.map(R=>R.y)),g=Math.max(...p.map(R=>R.y+R.height)),f=o.y,w=o.y+o.height,y=Math.max(0,Math.min(g,w)-Math.max(u,f)),m=Math.min(g-u,o.height),x=m>0?y/m:0,S=p[p.length-1],b=o.x-(S.x+S.width);if(x>=.4&&b<=i){p.push(o),c=!0;break}}c||d.push([o])}const l=d.map(o=>{const c=Math.min(...o.map(f=>f.x)),p=Math.min(...o.map(f=>f.y)),u=Math.max(...o.map(f=>f.x+f.width)),g=Math.max(...o.map(f=>f.y+f.height));return{x:c,y:p,width:u-c,height:g-p}});return l.sort((o,c)=>o.y-c.y||o.x-c.x),l}function Q(h,e){if(h)return N.GRAY;switch(e){case"high":return N.GREEN;case"medium":return N.YELLOW;case"low":return N.ORANGE;case"veryLow":return N.RED;default:return N.GRAY}}function Ot(h,e){const t=h.top+h.height,n=e.top+e.height,a=Math.max(0,Math.min(t,n)-Math.max(h.top,e.top)),s=Math.min(h.height,e.height);return s>0?a/s:0}function Pt(h,e){const t=Math.min(h.left,e.left),n=Math.max(h.left+h.width,e.left+e.width);return{left:t,width:n-t}}function Bt(h,e,t){const n=Pt(h,e);return{left:n.left,top:(h.top+e.top)/2,width:n.width,height:(h.height+e.height)/2}}function kt(h,e,t=ft,n){if(h.length<=1)return h;const a=n?n/3:1,r=h.filter(l=>l.height>=a).slice().sort((l,o)=>l.top===o.top?l.left-o.left:l.top-o.top),i=[];let d=r[0];for(let l=1;l<r.length;l+=1){const o=r[l];Ot(d,o)>=t?d=Bt(d,o):(i.push(d),d=o)}return i.push(d),i}const Lt="average",Nt=ft,ht=3;class ${static async drawHighlightBorder(e,t,n,a){const s=a?Tt:St,r={left:t.left-s,top:t.top-s,width:t.width+s*2,height:t.height+s*2},i=Q(!!n.data.isApplied,n.data.priority),d=`${D}::${n.shapeId}::${n.id}`,l=e.shapes.addGeometricShape(PowerPoint.GeometricShapeType.rectangle,r);l.name=d,l.lineFormat.visible=!0,l.lineFormat.color=i,l.lineFormat.weight=ht;try{l.fill.transparency=1}catch{}}static async highlightShape(e,t,n,a){t.load(["id","type","left","top","width","height"]),await a.sync();const s={left:t.left,top:t.top,width:t.width,height:t.height};await $.drawHighlightBorder(e,s,n),await a.sync()}static async highlightTableShape(e,t,n,a){t.load(["id","type","left","top","width","height"]),await a.sync();const s={left:t.left,top:t.top,width:t.width,height:t.height};await $.drawHighlightBorder(e,s,n),await a.sync()}static async updateHighlightColor(e,t,n,a){const s=e.shapes;s.load("items"),await a.sync();for(const r of s.items)r.name===t&&(r.lineFormat.color=n)}static async highlightTextShape(e,t,n,a,s){e.load("shapes/items"),await s.sync();let r;if(a?r=[{left:t.left,top:t.top,width:t.width,height:t.height}]:r=await $.getSubstringBoundingBoxesForText(n,e,t,s),await s.sync(),r.length)try{await $.deleteHighlightShape(e,`${D}::${n.shapeId}::${n.id}`,s)}catch{}await s.sync();for(const i of r)await $.drawHighlightBorder(e,i,n);await s.sync()}static async clearHighlights(){try{await PowerPoint.run(async e=>{const n=e.presentation.slides;n.load("items"),await e.sync();for(const a of n.items){const s=a.shapes;s.load("items"),await e.sync();for(const r of s.items)r.name.startsWith(D)&&r.delete()}await e.sync()})}catch(e){throw new Error("[clearHighlights] failed",{cause:e})}}static async toggleHighlights(e){try{await PowerPoint.run(async t=>{const a=t.presentation.slides;a.load("items"),await t.sync();for(const s of a.items){const r=s.shapes;r.load("items"),await t.sync();for(const i of r.items)i.name.startsWith(D)&&(i.load(["lineFormat/visible","lineFormat/weight","lineFormat/color"]),await t.sync(),i.lineFormat.weight=e?ht:0,i.lineFormat.transparency=e?0:1)}await t.sync()})}catch(t){console.warn("[hideHighlights] failed",t)}}static async deleteHighlightShape(e,t,n){e.shapes.load("items/id,items/name"),await n.sync();const a=[];for(const s of e.shapes.items)s.name===t&&a.push(s.id);if(a.length!==0){for(const s of a)e.shapes.getItem(s).delete();await n.sync()}}static async updateHighlight(e,t,n,a,s){try{if(t.type===PowerPoint.ShapeType.image||t.type===PowerPoint.ShapeType.chart){await $.updateHighlightColor(e,`${D}::${n.shapeId}::${n.id}`,Q(!!n.data.isApplied,n.data.priority),s);return}if(t.type===PowerPoint.ShapeType.table){await $.updateHighlightColor(e,`${D}::${n.shapeId}::${n.id}`,Q(!!n.data.isApplied,n.data.priority),s);return}if(!Et(n.data))throw new Error(`[updateHighlight] initialText not found in item data. Item id=${n.id} shapeId=${n.shapeId}, slideId=${n.slideId}`);await $.highlightTextShape(e,t,n,a,s),await s.sync()}catch(r){throw new Error("[updateHighlight] failed",{cause:r})}}static async colorSubstringOnTextShape(e,t,n){try{if(!t.data.initialText)throw Error("[colorSubstringOnTextShape] No initialText in item data");if(!e.textFrame||!e.textFrame.textRange)throw Error("[colorSubstringOnTextShape] Shape is not a text shape");e.load(["textFrame/textRange/text"]),await n.sync();const a=e.textFrame.textRange.text;if(a.length===0)throw Error("[colorSubstringOnTextShape] Shape has no text");let s,r;if("hasSiblings"in t.data&&t.data.hasSiblings){const{rawStart:y,rawLength:m}=await I.findTargetRangeInShape(e,t,n);s=y,r=m}else s=z(a,t.data.initialText),r=t.data.initialText.length;if(s<0)throw Error(`[colorSubstringOnTextShape] Initial text not found in shape text (initialText=${t.data.initialText}, fullText=${a})`);const i=Math.max(a.lastIndexOf("\r",s),a.lastIndexOf(`
`,s))+1,d=a.indexOf("\r",s),l=a.indexOf(`
`,s),o=[d,l].filter(y=>y>=0).sort((y,m)=>y-m)[0]??a.length,c=Math.min(o,a.length);if(i>=c)throw Error("[colorSubstringOnTextShape] Paragraph not found in shape text");const p=c-i,u=e.textFrame.textRange.getSubstring(i,p),g=s-i,f=Math.min(r,Math.max(0,p-g));if(f<=0)throw Error("[colorSubstringOnTextShape] Invalid text length");const w=u.getSubstring(g,f);return w.load(["font/bold","font/color"]),await n.sync(),w.font.color=it,bt&&(w.font.bold=!0),await n.sync(),!0}catch(a){throw new Error("[colorSubstringOnTextShape] failed",{cause:a})}}static async getLastSlideData(e){const t=e.presentation.slides;t.load("items"),await e.sync();const n=t.items[t.items.length-1];return n.load(["id","index"]),await e.sync(),{id:n.id,index:n.index}}static async getSubstringBoundingBoxesForText(e,t,n,a){let s=null;try{const{slideId:r,shapeId:i,data:d,id:l}=e,{initialText:o}=d;if(!o||o.length===0)throw new Error("[getSubstringBoundingBoxesForTextShape] initialText is empty.");const c=lt(it),p=lt(ot);let u=null,g=0,f=0,w=0,y=0;const m=a.presentation;t.load(["index"]);const x=n.name||"",S=`FINGERPRINT::${r}::${i}::${l}`;n.name=S;const b=await this.getLastSlideData(a),R=b.index,O=t.exportAsBase64();await a.sync();const H=R+1;m.insertSlidesFromBase64(O.value,{targetSlideId:b.id,formatting:PowerPoint.InsertSlideFormatting.keepSourceFormatting}),n.name=x,await a.sync(),s=m.slides.getItemAt(H),await a.sync();const v=s.shapes;v.load("items"),await a.sync();const T=v.items.find(E=>E.name===S);if(!T){try{s.delete(),s=null}catch{}return await a.sync(),u=null,[]}if(!await this.colorSubstringOnTextShape(T,e,a)){try{s.delete(),s=null}catch{}return await a.sync(),u=null,[]}T.load(["left","top","width","height","textFrame/textRange/font"]),await a.sync();const M=s.shapes.addGeometricShape(PowerPoint.GeometricShapeType.rectangle);M.left=T.left,M.top=T.top,M.width=T.width,M.height=T.height,M.lineFormat.weight=3,M.lineFormat.color=ot,T.fill.setSolidColor(Rt),g=T.left,f=T.top,w=T.width,y=T.height;try{M.fill.transparency=1,await a.sync()}catch{}const G=s.getImageAsBase64({width:$t});await a.sync(),u=G.value||null;try{s.delete(),s=null}catch{}if(await a.sync(),!u)return[];const{canvasContext:P,width:W,height:tt}=await Ct(u),U=ct(P,W,tt,p,dt);if(U.length===0)return[];const et=(()=>{const E=Math.min(...U.map(A=>A.x)),j=Math.min(...U.map(A=>A.y)),st=Math.max(...U.map(A=>A.x+A.width)),Y=Math.max(...U.map(A=>A.y+A.height));return{x:E,y:j,width:st-E,height:Y-j}})(),at=ct(P,W,tt,c,dt,et);if(at.length===0)return[];const nt=At(at);if(nt.length===0)return[];const wt=nt.map(E=>Mt(E,et,{left:g,top:f,width:w,height:y}));return kt(wt,Lt,Nt,T.textFrame.textRange.font.size).map(E=>{const j=T.textFrame.textRange.font.size?Math.round(T.textFrame.textRange.font.size*.7):E.height,Y=T.height/j<2?j*.15:0;return{...E,top:E.top-Y,height:j}})}finally{s&&s.delete()}}static async repositionSiblingHighlighting(e,t,n,a){try{if(!e.textFrame||!e.textFrame.textRange)throw new Error(`[repositionSiblingHighlighting] Target is not a text shape. id=${n.id}, shapeId=${n.shapeId}, slideId=${n.slideId}`);const s=await $.getSubstringBoundingBoxesForText(n,t,e,a);if(s.length)try{await $.deleteHighlightShape(t,`${D}::${n.shapeId}::${n.id}`,a)}catch{}for(const r of s)await $.drawHighlightBorder(t,r,n);await a.sync()}catch(s){const r=`[repositionSiblingHighlighting] failed for id=${n.id}, shapeId=${n.shapeId}, slideId=${n.slideId}, initialText=${n.data.initialText??""}, occurrenceIndex=${n.data.occurrenceIndex??""}`;console.warn(r,s)}}}const B=void 0;class Ht{baseUrl="";securityData=null;securityWorker;abortControllers=new Map;customFetch=(...e)=>fetch(...e);baseApiParams={credentials:"same-origin",headers:{},redirect:"follow",referrerPolicy:"no-referrer"};constructor(e={}){Object.assign(this,e)}setSecurityData=e=>{this.securityData=e};encodeQueryParam(e,t){return`${encodeURIComponent(e)}=${encodeURIComponent(typeof t=="number"?t:`${t}`)}`}addQueryParam(e,t){return this.encodeQueryParam(t,e[t])}addArrayQueryParam(e,t){return e[t].map(a=>this.encodeQueryParam(t,a)).join("&")}toQueryString(e){const t=e||{};return Object.keys(t).filter(a=>typeof t[a]<"u").map(a=>Array.isArray(t[a])?this.addArrayQueryParam(t,a):this.addQueryParam(t,a)).join("&")}addQueryParams(e){const t=this.toQueryString(e);return t?`?${t}`:""}contentFormatters={"application/json":e=>e!==null&&(typeof e=="object"||typeof e=="string")?JSON.stringify(e):e,"application/vnd.api+json":e=>e!==null&&(typeof e=="object"||typeof e=="string")?JSON.stringify(e):e,"text/plain":e=>e!==null&&typeof e!="string"?JSON.stringify(e):e,"multipart/form-data":e=>e instanceof FormData?e:Object.keys(e||{}).reduce((t,n)=>{const a=e[n];return t.append(n,a instanceof Blob?a:typeof a=="object"&&a!==null?JSON.stringify(a):`${a}`),t},new FormData),"application/x-www-form-urlencoded":e=>this.toQueryString(e)};mergeRequestParams(e,t){return{...this.baseApiParams,...e,...t||{},headers:{...this.baseApiParams.headers||{},...e.headers||{},...t&&t.headers||{}}}}createAbortSignal=e=>{if(this.abortControllers.has(e)){const n=this.abortControllers.get(e);return n?n.signal:void 0}const t=new AbortController;return this.abortControllers.set(e,t),t.signal};abortRequest=e=>{const t=this.abortControllers.get(e);t&&(t.abort(),this.abortControllers.delete(e))};request=async({body:e,secure:t,path:n,type:a,query:s,format:r,baseUrl:i,cancelToken:d,...l})=>{const o=(typeof t=="boolean"?t:this.baseApiParams.secure)&&this.securityWorker&&await this.securityWorker(this.securityData)||{},c=this.mergeRequestParams(l,o),p=s&&this.toQueryString(s),u=this.contentFormatters[a||"application/json"],g=r||c.format;return this.customFetch(`${i||this.baseUrl||""}${n}${p?`?${p}`:""}`,{...c,headers:{...c.headers||{},...a&&a!=="multipart/form-data"?{"Content-Type":a}:{}},signal:(d?this.createAbortSignal(d):c.signal)||null,body:typeof e>"u"||e===null?null:u(e)}).then(async f=>{const w=f;w.data=null,w.error=null;const y=g?f.clone():f,m=g?await y[g]().then(x=>(w.ok?w.data=x:w.error=x,w)).catch(x=>(w.error=x,w)):w;if(d&&this.abortControllers.delete(d),!f.ok)throw m;return m})}}class jt extends Ht{api={getTaskStatus:(e,t={})=>this.request({path:`${B}/api/v1/tasks/${e}/status`,method:"GET",format:"json",...t}),sanitize:({file:e},t={})=>{const n=new FormData;return n.append("file",e),this.request({path:`${B}/api/v1/tasks/sanitize`,method:"POST",body:n,type:"multipart/form-data",format:"json",...t})},updateContent:(e,t,n,a={})=>{const s=new FormData;return s.append("file",n),this.request({path:`${B}/api/v1/tasks/${e}/update_content`,method:"POST",query:t,body:s,type:"multipart/form-data",format:"json",...a})},getFinalChangelog:(e,t={})=>this.request({path:`${B}/api/v1/changelogs/${e}/status`,method:"GET",format:"json",...t}),updateTaskChangelog:(e,t,n={})=>this.request({path:`${B}/api/v1/changelogs/${e}`,method:"POST",body:t,type:"application/json",format:"json",...n}),exportFinalChangelog:(e,t={})=>this.request({path:`${B}/api/v1/changelogs/${e}/export`,method:"GET",format:"json",...t}),uploadSlideScreenshot:(e,t,n,a={})=>{const s=new FormData;return s.append("file",n.file),this.request({path:`${B}/api/v1/screenshots/${e}/${t}`,method:"POST",body:s,type:"multipart/form-data",format:"json",...a})},async uploadAllScreenshots(e,t){return await Promise.all(t.map(async(n,a)=>{await this.uploadSlideScreenshot(e,a,{file:n})}))},async uploadPresentationFile(e,t,n={}){const a=n.intervalMs??3e3,r=(await this.sanitize({file:e})).data.taskId;return await this.uploadAllScreenshots(r,t),new Promise((i,d)=>{let l=null;const o=()=>{l!==null&&(clearTimeout(l),l=null),n.signal&&n.signal.removeEventListener("abort",c)},c=()=>{o(),d(new DOMException("Aborted","AbortError"))};if(n.signal?.aborted)return c();n.signal&&n.signal.addEventListener("abort",c,{once:!0});const p=async()=>{if(n.signal?.aborted)return c();try{const g=(await this.getTaskStatus(r)).data,f=g?.status;if(f==="failed")return o(),d(new Error("File processing task failed"));if(f==="completed")return g?.changelog?(o(),i({changelog:g.changelog,taskId:r})):(o(),d(new Error("Completed without changelog")));l=window.setTimeout(p,a)}catch(u){o(),d(u)}};p()})},removePresentationMetadata:(e,t={})=>{const n=new FormData;return n.append("file",e.file),this.request({path:`${B}/api/v1/presentations/remove_metadata`,method:"POST",body:n,type:"multipart/form-data",format:"json",...t})}}}function vt(h){if(h instanceof Uint8Array)return h;if(h instanceof ArrayBuffer)return new Uint8Array(h);if(Array.isArray(h))return new Uint8Array(h);if(h&&h.buffer)return new Uint8Array(h.buffer);throw new Error("Unsupported slice data type")}class zt{masterShapeNames=new Set;constructor(){Office.onReady(()=>{PowerPoint.run(async e=>{try{this.masterShapeNames=await this.getMasterShapeNames(e)}catch{}})})}async getMasterShapeNames(e){const t=new Set,n=e.presentation.slideMasters.load("items");await e.sync();for(const a of n.items){a.load("shapes"),await e.sync();for(const s of a.shapes.items)s.load("name"),await e.sync(),t.add(s.name)}return t}async getSlideData(e){try{return await PowerPoint.run(async t=>{const a=t.presentation.slides.getItem(e).exportAsBase64();await t.sync();const s=a.value,r=atob(s),i=new Uint8Array(r.length);for(let l=0;l<r.length;l+=1)i[l]=r.charCodeAt(l);const d=new Blob([i],{type:"application/vnd.openxmlformats-officedocument.presentationml.presentation"});return new File([d],"slide.pptx",{type:d.type})})}catch(t){throw Error(`Error getting slide data or creating file for slideId: ${e}`,{cause:t})}}async replaceSlide(e,t){try{return await PowerPoint.run(async n=>{const a=n.presentation,s=a.slides.getItem(e);s.load("index"),await n.sync();const r=s.index;a.insertSlidesFromBase64(t,{sourceSlideIds:[e],targetSlideId:e}),s.delete(),await n.sync();const i=a.slides.getItemAt(r);return i.load("id"),await n.sync(),i.id})}catch(n){throw Error(`Error replacing slide with id: ${e}`,{cause:n})}}groupBySlide(e){const t=new Map;for(const n of e){const a=t.get(n.slideId)??[];a.push(n),t.set(n.slideId,a)}return t}async findShapeInGroups(e,t,n){t.load("items/type"),await n.sync();const a=t.items.filter(r=>r.type===PowerPoint.ShapeType.group);if(a.length===0)return null;let s=null;for(const r of a){const i=r.group.shapes.getItemOrNullObject(e);if(await n.sync(),!i.isNullObject){s=i;break}const d=await this.findShapeInGroups(e,r.group.shapes,n);if(d){s=d;break}}return s}async getShapeById(e,t,n){try{const a=t.shapes.getItemOrNullObject(e);if(await n.sync(),!a.isNullObject)return a;t.load(["shapes"]),await n.sync();const s=t.shapes,r=await this.findShapeInGroups(e,s,n);if(!r)throw new Error("[getShapeById] Shape is not found on slide.");return r}catch(a){throw new Error(`[getShapeById] Failed to load shape with ID: ${e}`,{cause:a})}}async loadShapesByIds(e,t,n){const a=t.presentation,s=new Map,r=[],i=[];for(const[d,l]of e){const o=a.slides.getItem(d);s.set(d,o);for(const c of l){const{id:p,shapeId:u,data:g}=c;try{const f=g.shapeId?g.shapeId:u,w=await this.getShapeById(f,o,t);w.load([...n,"name"]),await t.sync(),r.push({id:p,slideId:d,shape:w,data:g})}catch(f){i.push({itemId:c.id,message:"Can not find the element",cause:new Error(`[loadShapesByIds] Failed to load shape. Item id=${c.id} shapeId=${u}, slideId=${d}`,{cause:f})})}}}return{loadedShapes:r,slides:s,unprocessedItems:i}}async getTableCell(e,t,n,a){if(t.type!=="Table"||!n&&n!==0||!a&&a!==0)throw Error(`[getTableCell] Not a table shape or row/column not defined. shapeId: ${t.id}, type: ${t.type} row: ${n}, column: ${a}`);const s=t.getTable(),r=s.rows.getCount(),i=s.columns.getCount();await e.sync();const d=r.value,l=i.value;if(n<0||a<0||n>=d||a>=l)throw Error(`[getTableCell] Row/column out of range. shapeId: ${t.id}, row: ${n}, column: ${a}, rowCount: ${d}, columnCount: ${l}`);const o=s.getCellOrNullObject(n,a);if(await e.sync(),o.isNullObject)throw new Error(`[getTableCell] Table cell is null. shapeId: ${t.id}, row: ${n}, column: ${a}`);return o}async goToSlideById(e){return new Promise((t,n)=>{Office.context.document.goToByIdAsync(e,Office.GoToType.Index,a=>{a.status===Office.AsyncResultStatus.Succeeded?t():n({error:a.error,slideNumber:e})})})}async addShapeMask(e){if(!e.length)return{updatedShapeIds:[],unprocessedItems:[]};const t=[],n=[],a=this.groupBySlide(e);return await PowerPoint.run(async s=>{const{loadedShapes:r,slides:i,unprocessedItems:d}=await this.loadShapesByIds(a,s,["id","type","left","top","width","height"]);d&&d.length>0&&n.push(...d);for(const l of r){const{id:o,slideId:c,shape:p,data:u}=l;try{const{left:g,top:f,width:w,height:y}=p,m=i.get(c),x=m.shapes.addGeometricShape(PowerPoint.GeometricShapeType.rectangle,{left:g,top:f,width:w,height:y});x.fill.setSolidColor(N.BG_GRAY),x.lineFormat.visible=!1,x.textFrame.textRange.text=u.text,x.textFrame.textRange.font.color=N.BLACK,x.textFrame.verticalAlignment=PowerPoint.TextVerticalAlignment.middleCentered,x.textFrame.textRange.paragraphFormat.horizontalAlignment=PowerPoint.ParagraphHorizontalAlignment.center,x.load("id"),await s.sync(),t.push(x.id),await $.updateHighlight(m,p,{id:o,shapeId:p.id,slideId:c,data:u},!1,s)}catch(g){t.push(null),n.push({itemId:o,message:"Can not apply changes to the item",cause:new Error(`[addShapeMask] Failed to apply mask for id=${o}, shapeId=${p.id}, slideId=${c}`,{cause:g})})}}await s.sync()}),{updatedShapeIds:t,unprocessedItems:n}}async removeShapes(e,t=!0){if(!e.length)return{unprocessedItems:[]};const n=[],a=this.groupBySlide(e);return await PowerPoint.run(async s=>{const{loadedShapes:r,slides:i,unprocessedItems:d}=await this.loadShapesByIds(a,s,["id","type","left","top","width","height"]);d&&d.length>0&&n.push(...d);for(const l of r){const{id:o,slideId:c,shape:p,data:u}=l,g=i.get(c);try{p.delete(),t&&await $.updateHighlight(g,p,{id:o,shapeId:"initialShapeId"in u&&u.initialShapeId?u.initialShapeId:p.id,slideId:c,data:u},!1,s),await s.sync()}catch(f){n.push({itemId:o,message:"Can not delete the image or image mask",cause:new Error(`[removeShapes] Failed to delete id=${o}, shapeId=${p.id}, slideId=${c}`,{cause:f})})}}}),{unprocessedItems:n}}async replaceTextInShapes(e){if(!e.length)return{unprocessedItems:[]};const t=this.groupBySlide(e),n=[];return await PowerPoint.run(async a=>{const{loadedShapes:s,unprocessedItems:r,slides:i}=await this.loadShapesByIds(t,a,["id","textFrame/textRange/font","textFrame/textRange/text","type","left","top","width","height","name"]),d=Array.from(i.values());a.trackedObjects.add(d),r&&r.length>0&&n.push(...r);try{for(const l of s){const{id:o,shape:c,data:p,slideId:u}=l,g=i.get(u);try{if(!g||!c.textFrame?.textRange)continue;a.trackedObjects.add(c);const f=this.masterShapeNames.has(c.name);await I.replaceTextInShape(c,{id:o,shapeId:c.id,slideId:u,data:p},f,a);try{const w=this.masterShapeNames.has(c.name);if(await $.updateHighlight(g,c,{id:o,shapeId:c.id,slideId:u,data:{...p,initialText:p.proposedText}},w,a),p.siblings?.length)for(const y of p.siblings)await $.repositionSiblingHighlighting(c,g,{id:y.id,slideId:u,shapeId:c.id,data:{...y,hasSiblings:!0}},a)}catch(w){console.warn("Can not update highlight after text replacement",w)}}catch(f){n.push({itemId:o,message:"Can not replace text in the element",cause:new Error(`[replaceTextInShapes] Failed to replace text (id=${o}, shapeId=${c.id}, slideId=${u})`,{cause:f})})}finally{a.trackedObjects.remove(c)}}}finally{a.trackedObjects.remove(d)}}),{unprocessedItems:n}}async replaceTextInTables(e){if(!e.length)return{textRuns:[],unprocessedItems:[]};const t=this.groupBySlide(e),n=[],a=[];return await PowerPoint.run(async s=>{const{loadedShapes:r,unprocessedItems:i}=await this.loadShapesByIds(t,s,["id","type"]);i&&i.length>0&&a.push(...i);for(const d of r){const{id:l,shape:o,data:c,slideId:p}=d,{row:u,column:g}=c;if(!c.initialText||!c.proposedText){a.push({itemId:l,message:"No text to replace found",cause:new Error(`[replaceTextInTables] Initial or proposed text not defined (id=${l}, shapeId=${o.id}, slideId=${p}, row=${u}, column=${g})`)});continue}try{const f=await this.getTableCell(s,o,u,g);if(f.load(["textRuns"]),await s.sync(),!f.textRuns)await I.replaceTextInSimpleCell(f,{id:l,shapeId:o.id,slideId:p,data:c},s);else{const{initialTextRuns:w}=await I.replaceTextInFormattedCell(f,{id:l,shapeId:o.id,slideId:p,data:c},s);n.push(w)}await s.sync()}catch(f){n.push(null);const w=f instanceof Error&&f.message.startsWith("[getTableCell]");a.push({itemId:l,message:w?"Table cell not found":"Can not replace text in the table cell",cause:new Error(`[replaceTextInTables] Failed to replace text (id=${l}, shapeId=${o.id}, slideId=${p}, row=${u}, column=${g})`,{cause:f})})}}}),{textRuns:n,unprocessedItems:a}}async revertTextInTables(e){if(!e.length)return{unprocessedItems:[]};const t=this.groupBySlide(e),n=[];return await PowerPoint.run(async a=>{const{loadedShapes:s,unprocessedItems:r}=await this.loadShapesByIds(t,a,["id","type"]);r&&r.length>0&&n.push(...r);for(const i of s){const{id:d,shape:l,data:o,slideId:c}=i,{row:p,column:u}=o;if(!o.initialText||!o.proposedText){n.push({itemId:d,message:"No text to revert found",cause:new Error(`[revertTextInTables] Initial or proposed text not defined (id=${d}, shapeId=${l.id}, slideId=${c}, row=${p}, column=${u})`)});continue}try{const g=await this.getTableCell(a,l,p,u);g.load(["text","textRuns","font"]),await a.sync(),g.textRuns?await I.revertTextInFormattedCell(g,{id:d,slideId:c,shapeId:l.id,data:o},a):await I.replaceTextInSimpleCell(g,{id:d,shapeId:l.id,slideId:c,data:o},a)}catch(g){const f=g instanceof Error&&g.message.startsWith("[getTableCell]");n.push({itemId:d,message:f?"Table cell not found":"Can not revert text in the table cell",cause:new Error(`[revertTextInTables] Failed to revert text (id=${d}, shapeId=${l.id}, slideId=${c}, row=${p}, column=${u})`,{cause:g})})}}}),{unprocessedItems:n}}async getCurrentScreenshots(){const e={};try{await PowerPoint.run(async t=>{const n=t.presentation.slides;n.load("items"),await t.sync();for(const a of n.items){a.load("index");const s=a.getImageAsBase64();await t.sync(),e[a.index]=s.value?`data:image/png;base64,${s.value}`:""}})}catch(t){throw new Error("[getCurrentScreenshots] failed",{cause:t})}return e}async getSlideIdsList(){const e=[];try{await PowerPoint.run(async t=>{const n=t.presentation.slides;n.load("items"),await t.sync();for(const a of n.items)a.load("id");await t.sync();for(const a of n.items)e.push(a.id)})}catch(t){throw new Error("[getSlideIdsList] failed",{cause:t})}return e}async getCurrentFile(){const e="application/vnd.openxmlformats-officedocument.presentationml.presentation";return new Promise((n,a)=>{Office.context.document.getFileAsync(Office.FileType.Compressed,{sliceSize:4194304},s=>{s.status!==Office.AsyncResultStatus.Succeeded&&a(new Error("Failed to get file",{cause:s}));const r=s.value,i=r.sliceCount,d=[];let l=0;const o=()=>r.closeAsync(()=>{}),c=()=>{r.getSliceAsync(l,p=>{if(p.status!==Office.AsyncResultStatus.Succeeded){o(),a(new Error(String(p.error||p.status)));return}if(d.push(vt(p.value.data)),l++,l<i)c();else{const u=new Blob(d,{type:e}),g=new File([u],"presentation.pptx",{type:e});o(),n(g)}})};c()})})}async addMarkersForChangelog(e){try{await PowerPoint.run(async t=>{const n=t.presentation;for(const a of e){const s=n.slides.getItem(a.slideId);for(const r of a.items)try{const i=await this.getShapeById(r.shapeId,s,t);i.load("type"),await t.sync();const d={id:r.id,slideId:r.slideId,shapeId:r.shapeId,data:{priority:r.priority,isApplied:r.isApplied,initialText:r.initialValue,proposedText:r.proposedValue||"",hasSiblings:r.hasSibling,occurrenceIndex:r.occurrenceIndex,siblings:r.siblings?.map(l=>{const o=a.items.find(c=>c.id===l.id);return{...l,proposedText:o?.proposedValue||"",priority:o?.priority||"unknown",isApplied:o?.isApplied}})}};if(i.type===PowerPoint.ShapeType.table){const o=i.getTable().getCellOrNullObject(r.row,r.column);if(await t.sync(),!o.isNullObject){o.load(["text","textRuns","font"]),await t.sync();const c={...d,data:{...d.data,row:r.row,column:r.column}};o.textRuns&&o.textRuns.length>0?await I.addMarkersForSimpleCell(o,c,t):I.addMarkersForFormattedCell(o.textRuns,c,o.font)}}await I.addMarkersForShape(i,d,t),i.textFrame.textRange.load("text"),await t.sync()}catch(i){console.warn(`[addMarkersForChangelog] Failed to add markers for item: id=${r.id}, shapeId=${r.shapeId}, slideId=${a.slideId}`,{cause:i})}}await t.sync()})}catch(t){console.warn("[addMarkersForChangelog] failed",{cause:t})}}async prepareLayoutForChangelog(e){try{const t=mt(e);await this.addMarkersForChangelog(t),await this.highlightChangelogItems(e)}catch{}}async highlightChangelogItems(e){try{await PowerPoint.run(async t=>{const n=t.presentation;for(const a of e){const s=n.slides.getItem(a.slideId);for(const r of a.items)try{const i=await this.getShapeById(r.shapeId,s,t);i.load(["type","name"]),await t.sync();const d={id:r.id,slideId:r.slideId,shapeId:r.shapeId,data:{proposedText:r.proposedValue||"",priority:r.priority,isApplied:r.isApplied,hasSiblings:r.hasSibling,occurrenceIndex:r.occurrenceIndex,siblings:r.siblings?.map(l=>{const o=a.items.find(c=>c.id===l.id);return{...l,proposedText:o?.proposedValue||"",priority:o?.priority||"unknown",isApplied:o?.isApplied}})}};if(r.shapeType==="image"||r.shapeType==="chart"){await $.highlightShape(s,i,d,t);continue}if(r.shapeType==="table"){await $.highlightTableShape(s,i,d,t);continue}if(r.shapeType==="text"){const l=this.masterShapeNames.has(i.name);await $.highlightTextShape(s,i,{...d,data:{...d.data,initialText:r.isApplied?r.proposedValue:r.initialValue,proposedText:r.isApplied?r.initialValue||"":r.proposedValue||""}},l,t)}}catch(i){console.warn(`[highlightChangelogItems] Failed to highlight item: id=${r.id}, shapeId=${r.shapeId}, slideId=${a.slideId}`,{cause:i})}}await t.sync()})}catch(t){console.warn("[highlightChangelogItems] failed",{cause:t})}}}export{jt as A,$ as H,I as M,zt as P};
